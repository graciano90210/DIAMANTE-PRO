{% extends "base.html" %}

{% block title %}Nueva Sociedad - Diamante Pro{% endblock %}

{% block page_title %}
<i class="bi bi-plus-circle me-2"></i>Crear Nueva Sociedad
{% endblock %}

{% block extra_css %}
<style>
    .form-card {
        background: linear-gradient(145deg, #1D1E33 0%, #151627 100%);
        border-radius: 20px;
        border: 1px solid rgba(0, 229, 255, 0.1);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    
    .card-header-dark {
        background: linear-gradient(135deg, rgba(0, 255, 153, 0.15) 0%, rgba(0, 229, 255, 0.1) 100%);
        border-bottom: 1px solid rgba(0, 255, 153, 0.2);
        border-radius: 20px 20px 0 0 !important;
        padding: 1.25rem 1.5rem;
    }
    
    .card-header-dark h4 {
        color: #00FF99;
        margin: 0;
        font-weight: 600;
    }
    
    .section-title {
        color: #00E5FF;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 1px;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(0, 229, 255, 0.2);
    }
    
    .form-control, .form-select {
        background: #0A0E21;
        border: 1px solid rgba(0, 229, 255, 0.2);
        color: #E0E0E0;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        background: #0A0E21;
        border-color: #00E5FF;
        box-shadow: 0 0 0 3px rgba(0, 229, 255, 0.15);
        color: #ffffff;
    }
    
    .form-control::placeholder {
        color: #6c757d;
    }
    
    .form-label {
        color: #B0B0B0;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    
    .form-label.fw-bold {
        color: #E0E0E0;
    }
    
    .socio-card {
        background: rgba(0, 229, 255, 0.05);
        border: 2px solid rgba(0, 229, 255, 0.15);
        border-radius: 15px;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .socio-card:hover {
        border-color: #00E5FF;
        box-shadow: 0 5px 20px rgba(0, 229, 255, 0.15);
    }
    
    .socio-card .card-header {
        border-radius: 13px 13px 0 0 !important;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .socio-card .btn-remove {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        background: rgba(255, 107, 107, 0.2);
        border: 1px solid #FF6B6B;
        color: #FF6B6B;
        border-radius: 8px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .socio-card .btn-remove:hover {
        background: #FF6B6B;
        color: #fff;
    }
    
    .add-socio-btn {
        border: 2px dashed rgba(0, 229, 255, 0.3);
        background: transparent;
        color: #00E5FF;
        transition: all 0.3s ease;
        border-radius: 15px;
    }
    
    .add-socio-btn:hover {
        border-color: #00E5FF;
        background: rgba(0, 229, 255, 0.1);
        color: #00E5FF;
    }
    
    .porcentaje-bar {
        height: 30px;
        transition: width 0.3s ease;
        font-weight: 600;
    }
    
    .progress {
        background: #0A0E21;
        border-radius: 10px;
        overflow: hidden;
        height: 30px;
    }
    
    .progress-bar.bg-primary {
        background: linear-gradient(135deg, #00E5FF 0%, #0088cc 100%) !important;
    }
    
    .progress-bar.bg-success {
        background: linear-gradient(135deg, #00FF99 0%, #00cc77 100%) !important;
    }
    
    .progress-bar.bg-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
    }
    
    .progress-bar.bg-warning {
        background: linear-gradient(135deg, #FFD700 0%, #ccac00 100%) !important;
        color: #0A0E21 !important;
    }
    
    .btn-guardar {
        background: linear-gradient(135deg, #00E5FF 0%, #00FF99 100%);
        border: none;
        color: #0A0E21;
        font-weight: 600;
        padding: 0.875rem 2rem;
        border-radius: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
    }
    
    .btn-guardar:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 229, 255, 0.35);
        color: #0A0E21;
    }
    
    .btn-guardar:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-cancelar {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #B0B0B0;
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    
    .btn-cancelar:hover {
        border-color: #FF6B6B;
        color: #FF6B6B;
        background: rgba(255, 107, 107, 0.1);
    }
    
    .alert-dueno {
        background: rgba(0, 229, 255, 0.1);
        border: 1px solid rgba(0, 229, 255, 0.3);
        border-radius: 12px;
        color: #E0E0E0;
    }
    
    .input-group-text {
        background: rgba(0, 229, 255, 0.1);
        border: 1px solid rgba(0, 229, 255, 0.2);
        color: #00E5FF;
    }
    
    .badge-contador {
        background: rgba(0, 229, 255, 0.2);
        color: #00E5FF;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-10 offset-lg-1">
            <div class="card form-card">
                <div class="card-header-dark">
                    <h4><i class="bi bi-plus-circle me-2"></i>Crear Nueva Sociedad</h4>
                </div>
                <div class="card-body p-4">
                    {% if error %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endif %}

                    <form method="POST" action="/sociedades/guardar" id="formSociedad">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Nombre de la Sociedad *</label>
                                <input type="text" name="nombre" class="form-control" required 
                                       placeholder="Ej: Sociedad Inversores 2024">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Fecha de Constitución</label>
                                <input type="date" name="fecha_constitucion" class="form-control" 
                                       value="{{ fecha_hoy }}">
                            </div>
                        </div>

                        <!-- Barra visual de distribución de porcentajes -->
                        <div class="mb-4">
                            <label class="form-label fw-bold section-title">Distribución de Participación</label>
                            <div class="progress" style="height: 30px;">
                                <div id="bar-dueno" class="progress-bar bg-primary porcentaje-bar" 
                                     style="width: 100%">Dueño: 100%</div>
                            </div>
                            <div id="porcentaje-alert" class="alert alert-warning mt-2 d-none">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Los porcentajes deben sumar exactamente 100%
                            </div>
                        </div>

                        <!-- Container para socios dinámicos -->
                        <div id="sociosContainer">
                            <h5 class="mb-3 section-title">
                                <i class="bi bi-people-fill me-2"></i>Socios Inversores
                                <span class="badge badge-contador ms-2" id="contadorSocios">0 socios</span>
                            </h5>
                            
                            <!-- Los socios se agregan dinámicamente aquí -->
                        </div>

                        <!-- Botón para agregar más socios -->
                        <div class="text-center mb-4">
                            <button type="button" class="btn add-socio-btn py-3 px-5" onclick="agregarSocio()">
                                <i class="bi bi-plus-circle fs-4"></i><br>
                                <span>Agregar Socio</span>
                            </button>
                        </div>

                        <!-- Porcentaje del dueño -->
                        <div class="alert alert-dueno mb-4">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <strong><i class="bi bi-person-fill-gear me-2"></i>Porcentaje del Dueño:</strong>
                                    <span id="porcentaje_dueno" class="fs-4 fw-bold ms-2" style="color: #00E5FF;">100%</span>
                                    <small class="d-block text-muted mt-1">Se calcula automáticamente (100% - suma de socios)</small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <input type="hidden" name="porcentaje_dueno" id="input_porcentaje_dueno" value="100">
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Notas / Observaciones</label>
                            <textarea name="notas" class="form-control" rows="3" 
                                      placeholder="Acuerdos, condiciones, términos de la sociedad, etc."></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-guardar btn-lg" id="btnGuardar">
                                <i class="bi bi-check-circle me-2"></i>Crear Sociedad
                            </button>
                            <a href="/sociedades" class="btn btn-cancelar">
                                <i class="bi bi-x-circle me-2"></i>Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let socioIndex = 0;
    const colores = ['bg-success', 'bg-info', 'bg-warning', 'bg-danger', 'bg-secondary', 'bg-dark'];
    
    function agregarSocio() {
        socioIndex++;
        const container = document.getElementById('sociosContainer');
        const color = colores[(socioIndex - 1) % colores.length];
        
        const socioHTML = `
            <div class="card socio-card mb-3 position-relative" id="socio-${socioIndex}" data-index="${socioIndex}">
                <button type="button" class="btn btn-sm btn-remove" onclick="eliminarSocio(${socioIndex})">
                    <i class="bi bi-x-lg"></i>
                </button>
                <div class="card-header ${color} text-white">
                    <h6 class="mb-0"><i class="bi bi-person-fill me-2"></i>Socio ${socioIndex}</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Nombre Completo *</label>
                            <input type="text" name="socio_nombre[]" class="form-control" required 
                                   placeholder="Nombre del socio">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold">Documento</label>
                            <input type="text" name="socio_documento[]" class="form-control" 
                                   placeholder="C.C. / NIT">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold">Porcentaje (%) *</label>
                            <input type="number" name="socio_porcentaje[]" class="form-control porcentaje-input" 
                                   value="0" min="0.1" max="99" step="0.1" required 
                                   onchange="recalcularPorcentajes()" oninput="recalcularPorcentajes()">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Teléfono</label>
                            <input type="text" name="socio_telefono[]" class="form-control" 
                                   placeholder="Ej: 3001234567">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="socio_email[]" class="form-control" 
                                   placeholder="correo@ejemplo.com">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tipo de Socio</label>
                            <select name="socio_tipo[]" class="form-select">
                                <option value="INVERSIONISTA">Inversionista</option>
                                <option value="CAPITALISTA">Capitalista</option>
                                <option value="OPERADOR">Operador</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Monto Aportado</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" name="socio_monto[]" class="form-control" 
                                       placeholder="0" min="0">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Banco / Cuenta</label>
                            <input type="text" name="socio_banco[]" class="form-control" 
                                   placeholder="Banco y número de cuenta">
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', socioHTML);
        actualizarContador();
        recalcularPorcentajes();
    }
    
    function eliminarSocio(index) {
        const socioCard = document.getElementById(`socio-${index}`);
        if (socioCard) {
            socioCard.remove();
            actualizarContador();
            recalcularPorcentajes();
        }
    }
    
    function actualizarContador() {
        const count = document.querySelectorAll('.socio-card').length;
        document.getElementById('contadorSocios').textContent = 
            count === 1 ? '1 socio' : `${count} socios`;
    }
    
    function recalcularPorcentajes() {
        const inputs = document.querySelectorAll('input[name="socio_porcentaje[]"]');
        let totalSocios = 0;
        
        inputs.forEach(input => {
            totalSocios += parseFloat(input.value) || 0;
        });
        
        const porcentajeDueno = 100 - totalSocios;
        document.getElementById('porcentaje_dueno').textContent = porcentajeDueno.toFixed(1) + '%';
        document.getElementById('input_porcentaje_dueno').value = porcentajeDueno.toFixed(1);
        
        // Actualizar barra visual
        const barDueno = document.getElementById('bar-dueno');
        barDueno.style.width = porcentajeDueno + '%';
        barDueno.textContent = `Dueño: ${porcentajeDueno.toFixed(1)}%`;
        
        // Validar
        const alert = document.getElementById('porcentaje-alert');
        const btnGuardar = document.getElementById('btnGuardar');
        
        if (totalSocios > 100) {
            alert.classList.remove('d-none');
            alert.className = 'alert alert-danger mt-2';
            alert.innerHTML = '<i class="bi bi-x-circle me-2"></i>Los porcentajes de socios superan el 100%';
            btnGuardar.disabled = true;
        } else if (porcentajeDueno < 0) {
            alert.classList.remove('d-none');
            alert.className = 'alert alert-danger mt-2';
            btnGuardar.disabled = true;
        } else {
            alert.classList.add('d-none');
            btnGuardar.disabled = false;
        }
        
        // Actualizar barras de cada socio
        actualizarBarras(inputs, porcentajeDueno);
    }
    
    function actualizarBarras(inputs, porcentajeDueno) {
        const progressBar = document.querySelector('.progress');
        let html = `<div id="bar-dueno" class="progress-bar bg-primary porcentaje-bar" style="width: ${porcentajeDueno}%">Dueño: ${porcentajeDueno.toFixed(1)}%</div>`;
        
        inputs.forEach((input, index) => {
            const valor = parseFloat(input.value) || 0;
            if (valor > 0) {
                const color = colores[index % colores.length];
                html += `<div class="progress-bar ${color} porcentaje-bar" style="width: ${valor}%">S${index+1}: ${valor}%</div>`;
            }
        });
        
        progressBar.innerHTML = html;
    }
    
    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        // Opcional: agregar un socio por defecto
        // agregarSocio();
    });
</script>
{% endblock %}
