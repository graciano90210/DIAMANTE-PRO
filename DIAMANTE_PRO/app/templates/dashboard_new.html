{% extends "base.html" %}

{% block title %}Dashboard - Diamante Pro{% endblock %}

{% block page_title %}Panel de Control{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    /* ==================== CURRENCY TOGGLE ==================== */
    .currency-toggle {
        display: inline-flex;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 25px;
        padding: 3px;
        border: 1px solid rgba(0, 229, 255, 0.25);
    }
    .currency-toggle .ct-btn {
        padding: 6px 14px;
        border-radius: 22px;
        border: none;
        background: transparent;
        color: #8D8E98;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.25s ease;
        white-space: nowrap;
    }
    .currency-toggle .ct-btn.active {
        background: linear-gradient(135deg, #00E5FF 0%, #00D67F 100%);
        color: #0A0E21;
        box-shadow: 0 2px 12px rgba(0, 229, 255, 0.4);
    }
    .currency-toggle .ct-btn:hover:not(.active) {
        color: #fff;
        background: rgba(255, 255, 255, 0.08);
    }

    /* ==================== COMMAND TOOLBAR ==================== */
    .command-toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }
    .cmd-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.9rem;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
    }
    .cmd-btn:hover {
        transform: translateY(-2px);
        text-decoration: none;
    }
    .cmd-btn i { font-size: 1.1rem; }
    .cmd-primary {
        background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
        color: #fff !important;
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.35);
    }
    .cmd-primary:hover {
        box-shadow: 0 6px 25px rgba(37, 99, 235, 0.5);
        color: #fff !important;
    }
    .cmd-warning {
        background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        color: #0A0E21 !important;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.35);
    }
    .cmd-warning:hover {
        box-shadow: 0 6px 25px rgba(245, 158, 11, 0.5);
        color: #0A0E21 !important;
    }
    .cmd-outline {
        background: transparent;
        color: #00E5FF !important;
        border: 1px solid rgba(0, 229, 255, 0.4);
    }
    .cmd-outline:hover {
        background: rgba(0, 229, 255, 0.1);
        border-color: #00E5FF;
        box-shadow: 0 4px 15px rgba(0, 229, 255, 0.2);
        color: #00E5FF !important;
    }

    /* ==================== KPI CARDS ==================== */
    .kpi-card {
        background: #161B22;
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 14px;
        padding: 20px;
        transition: all 0.3s ease;
        height: 100%;
    }
    .kpi-card:hover {
        border-color: rgba(0, 229, 255, 0.2);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    .kpi-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    .kpi-label {
        color: #8B949E;
        font-size: 0.78rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .kpi-icon {
        font-size: 1.3rem;
        opacity: 0.6;
    }
    .kpi-value {
        font-size: 1.7rem;
        font-weight: 700;
        color: #fff;
        line-height: 1.2;
        margin-bottom: 8px;
    }
    .kpi-detail {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.78rem;
        font-weight: 500;
    }
    .kpi-detail.positive { color: #00D67F; }
    .kpi-detail.negative { color: #FF4757; }
    .kpi-detail.neutral { color: #8B949E; }
    .kpi-accent-green { border-left: 3px solid #00D67F; }
    .kpi-accent-blue { border-left: 3px solid #2563EB; }
    .kpi-accent-red { border-left: 3px solid #FF4757; }
    .kpi-accent-yellow { border-left: 3px solid #F59E0B; }

    /* Progress bar mini */
    .kpi-progress {
        height: 6px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 3px;
        overflow: hidden;
        margin-top: 10px;
    }
    .kpi-progress-bar {
        height: 100%;
        border-radius: 3px;
        background: linear-gradient(90deg, #00E5FF, #00D67F);
        transition: width 0.6s ease;
    }

    /* ==================== CHART SECTION ==================== */
    .panel-card {
        background: #161B22;
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 14px;
        padding: 20px;
    }
    .panel-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: #E0E0E0;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .panel-title i { color: #00E5FF; font-size: 1rem; }
    .chart-wrapper {
        position: relative;
        height: 260px;
    }

    /* ==================== EXPENSE FEED ==================== */
    .expense-feed {
        max-height: 320px;
        overflow-y: auto;
    }
    .expense-feed::-webkit-scrollbar { width: 4px; }
    .expense-feed::-webkit-scrollbar-thumb {
        background: rgba(0, 229, 255, 0.2);
        border-radius: 2px;
    }
    .expense-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }
    .expense-item:last-child { border-bottom: none; }
    .expense-icon {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        flex-shrink: 0;
        background: rgba(255, 71, 87, 0.15);
        color: #FF4757;
    }
    .expense-info { flex: 1; min-width: 0; }
    .expense-concept {
        color: #E0E0E0;
        font-size: 0.82rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .expense-meta {
        color: #8B949E;
        font-size: 0.72rem;
    }
    .expense-amount {
        color: #FF4757;
        font-weight: 700;
        font-size: 0.85rem;
        white-space: nowrap;
    }
    .feed-empty {
        text-align: center;
        padding: 30px 0;
        color: #8B949E;
    }
    .feed-empty i { font-size: 2rem; margin-bottom: 8px; display: block; opacity: 0.4; }
    .feed-link {
        display: block;
        text-align: center;
        padding: 10px;
        color: #00E5FF !important;
        font-size: 0.8rem;
        font-weight: 500;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
        margin-top: 8px;
    }
    .feed-link:hover { text-decoration: underline !important; }

    /* ==================== FILTER STYLES ==================== */
    .filter-selector-btn {
        background: linear-gradient(135deg, #1D1E33 0%, #252744 100%);
        border: 1px solid rgba(0, 229, 255, 0.4);
        color: #fff;
        padding: 8px 16px;
        border-radius: 25px;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    .filter-selector-btn:hover, .filter-selector-btn:focus {
        background: linear-gradient(135deg, #252744 0%, #2d2f54 100%);
        border-color: #00E5FF;
        color: #00E5FF;
        box-shadow: 0 4px 15px rgba(0, 229, 255, 0.3);
    }
    .filter-selector-btn::after { margin-left: 8px; }
    .filter-dropdown-menu {
        background: linear-gradient(180deg, #1D1E33 0%, #151624 100%);
        border: 1px solid rgba(0, 229, 255, 0.2);
        border-radius: 12px;
        padding: 8px 0;
        min-width: 280px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        max-height: 400px;
        overflow-y: auto;
    }
    .filter-dropdown-menu .dropdown-item {
        color: #E0E0E0;
        padding: 10px 16px;
        display: flex;
        align-items: center;
        transition: all 0.2s ease;
    }
    .filter-dropdown-menu .dropdown-item:hover {
        background: rgba(0, 229, 255, 0.1);
        color: #00E5FF;
    }
    .filter-dropdown-menu .dropdown-item.active {
        background: linear-gradient(90deg, rgba(0, 229, 255, 0.2) 0%, transparent 100%);
        color: #00E5FF;
        border-left: 3px solid #00E5FF;
    }
    .filter-dropdown-menu .dropdown-header {
        color: #8D8E98;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 8px 16px;
    }
    .filter-dropdown-menu .dropdown-divider {
        border-color: rgba(255, 255, 255, 0.08);
        margin: 4px 0;
    }
    .filter-dropdown-menu::-webkit-scrollbar { width: 6px; }
    .filter-dropdown-menu::-webkit-scrollbar-thumb {
        background: rgba(0, 229, 255, 0.3);
        border-radius: 3px;
    }

    /* ==================== BI DASHBOARD BANNER ==================== */
    @keyframes bi-gradient-shift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    @keyframes bi-pulse-glow {
        0%, 100% { box-shadow: 0 0 15px rgba(0, 229, 255, 0.1), inset 0 0 15px rgba(0, 229, 255, 0.03); }
        50% { box-shadow: 0 0 25px rgba(0, 229, 255, 0.25), inset 0 0 25px rgba(0, 229, 255, 0.06); }
    }
    @keyframes bi-float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }
    @keyframes bi-dot-pulse {
        0%, 100% { opacity: 1; box-shadow: 0 0 6px #00FF99; }
        50% { opacity: 0.2; box-shadow: 0 0 2px #00FF99; }
    }
    @keyframes bi-sweep {
        0% { left: -60%; }
        100% { left: 120%; }
    }
    @keyframes bi-border-flow {
        0% { background-position: 0% 0%; }
        100% { background-position: 200% 0%; }
    }
    .bi-banner {
        position: relative;
        display: block;
        padding: 18px 24px;
        border-radius: 14px;
        background: linear-gradient(135deg, #0B1120 0%, #111D35 30%, #1A1040 60%, #0F2847 100%);
        background-size: 250% 250%;
        animation: bi-gradient-shift 10s ease infinite, bi-pulse-glow 4s ease-in-out infinite;
        border: 1px solid transparent;
        overflow: hidden;
        text-decoration: none !important;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .bi-banner::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 14px;
        padding: 1px;
        background: linear-gradient(90deg, #00E5FF, #7B61FF, #00FF99, #00E5FF);
        background-size: 200% 100%;
        animation: bi-border-flow 4s linear infinite;
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        pointer-events: none;
    }
    .bi-banner::after {
        content: '';
        position: absolute;
        top: 0;
        left: -60%;
        width: 40%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.04), transparent);
        animation: bi-sweep 5s ease-in-out infinite;
        pointer-events: none;
    }
    .bi-banner:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 40px rgba(0, 229, 255, 0.2), 0 0 60px rgba(123, 97, 255, 0.1) !important;
    }
    .bi-banner:hover .bi-banner-icon-wrap {
        transform: scale(1.1);
        box-shadow: 0 0 30px rgba(0, 229, 255, 0.4);
    }
    .bi-banner:hover .bi-banner-go {
        transform: translateX(5px);
        opacity: 1;
    }
    .bi-banner-icon-wrap {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(0, 229, 255, 0.15) 0%, rgba(123, 97, 255, 0.15) 100%);
        border: 1px solid rgba(0, 229, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.4s ease;
        animation: bi-float 3s ease-in-out infinite;
    }
    .bi-banner-icon-wrap i {
        font-size: 1.5rem;
        background: linear-gradient(135deg, #00E5FF, #7B61FF);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .bi-banner-live-tag {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 3px 10px;
        border-radius: 20px;
        background: rgba(0, 255, 153, 0.08);
        border: 1px solid rgba(0, 255, 153, 0.25);
        font-size: 0.65rem;
        font-weight: 700;
        letter-spacing: 1.2px;
        color: #00FF99;
        text-transform: uppercase;
    }
    .bi-banner-live-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #00FF99;
        animation: bi-dot-pulse 1.5s ease-in-out infinite;
    }
    .bi-banner-go {
        color: rgba(0, 229, 255, 0.5);
        font-size: 1.4rem;
        transition: all 0.3s ease;
        opacity: 0.5;
    }
    .bi-banner-grid-bg {
        position: absolute;
        inset: 0;
        background-image:
            radial-gradient(circle at 20% 80%, rgba(0, 229, 255, 0.04) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(123, 97, 255, 0.04) 0%, transparent 50%);
        pointer-events: none;
    }

    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 768px) {
        .command-toolbar { gap: 8px; }
        .cmd-btn { padding: 8px 14px; font-size: 0.8rem; }
        .cmd-btn span { display: none; }
        .kpi-value { font-size: 1.3rem; }
        .currency-toggle .ct-btn { padding: 5px 10px; font-size: 0.75rem; }
        .bi-banner { padding: 14px 16px; }
        .bi-banner-icon-wrap { width: 40px; height: 40px; }
        .bi-banner-icon-wrap i { font-size: 1.2rem; }
        .bi-banner h5 { font-size: 0.9rem !important; }
        .bi-banner .bi-sub { display: none; }
    }
</style>
{% endblock %}

{% block navbar_actions %}
<!-- Selector de Oficinas y Rutas -->
{% if rol in ['dueno', 'gerente'] %}
<div class="dropdown d-none d-md-inline-block">
    <button class="btn btn-sm dropdown-toggle filter-selector-btn" type="button"
            id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="bi bi-funnel-fill me-1"></i>
        {% if oficina_seleccionada %}
            <i class="bi bi-building me-1"></i>{{ oficina_seleccionada.nombre }}
        {% elif ruta_seleccionada %}
            <i class="bi bi-signpost-2 me-1"></i>{{ ruta_seleccionada.nombre }}
        {% else %}
            <i class="bi bi-globe me-1"></i>Todo el Negocio
        {% endif %}
    </button>
    <ul class="dropdown-menu dropdown-menu-dark filter-dropdown-menu" aria-labelledby="filterDropdown">
        <li>
            <a class="dropdown-item {% if not oficina_seleccionada and not ruta_seleccionada %}active{% endif %}"
               href="/ver-todas-rutas">
                <i class="bi bi-globe me-2 text-info"></i>
                <span>Todo el Negocio</span>
                <small class="ms-auto text-muted">Global</small>
            </a>
        </li>
        {% if todas_las_oficinas %}
        <li><hr class="dropdown-divider"></li>
        <li><h6 class="dropdown-header"><i class="bi bi-building me-2"></i>Oficinas</h6></li>
        {% for oficina in todas_las_oficinas %}
        <li>
            <a class="dropdown-item {% if oficina_seleccionada and oficina_seleccionada.id == oficina.id %}active{% endif %}"
               href="/seleccionar-oficina/{{ oficina.id }}">
                <i class="bi bi-building me-2 text-warning"></i>
                <span>{{ oficina.nombre }}</span>
                <span class="badge bg-secondary ms-auto">{{ oficina.numero_rutas }} rutas</span>
            </a>
        </li>
        {% endfor %}
        {% endif %}
        {% if todas_las_rutas %}
        <li><hr class="dropdown-divider"></li>
        <li><h6 class="dropdown-header"><i class="bi bi-signpost-2 me-2"></i>Rutas</h6></li>
        <li>
            <input type="text" class="form-control mb-2" id="rutaSearchInput" placeholder="Buscar ruta..." onkeyup="filterRutas()">
        </li>
        {% for ruta in todas_las_rutas %}
        <li class="ruta-item">
            <a class="dropdown-item {% if ruta_seleccionada and ruta_seleccionada.id == ruta.id %}active{% endif %}"
               href="/seleccionar-ruta/{{ ruta.id }}">
                <i class="bi bi-signpost-2 me-2 text-success"></i>
                <span class="ruta-nombre">{{ ruta.nombre }}</span>
                {% if ruta.moneda %}
                <span class="badge bg-{% if ruta.moneda == 'BRL' %}success{% else %}primary{% endif %} ms-auto">{{ ruta.moneda }}</span>
                {% endif %}
            </a>
        </li>
        {% endfor %}
        {% endif %}
    </ul>
</div>
{% endif %}

<!-- Toggle de Moneda Global -->
{% if monedas_activas|length > 1 %}
<div class="currency-toggle" id="currencyToggle">
    {% for moneda in monedas_activas %}
    <button class="ct-btn {% if loop.first %}active{% endif %}"
            data-currency="{{ moneda }}"
            onclick="switchCurrency('{{ moneda }}')">
        {{ simbolos_moneda.get(moneda, '$') }} {{ moneda }}
    </button>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block content %}
<!-- Alerta de Filtro Activo -->
{% if oficina_seleccionada or ruta_seleccionada %}
<div class="mb-4" style="background: linear-gradient(135deg, rgba(0, 229, 255, 0.08) 0%, rgba(0, 255, 153, 0.05) 100%); border: 1px solid rgba(0, 229, 255, 0.25); border-radius: 12px; padding: 12px 20px;">
    <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
            {% if oficina_seleccionada %}
            <i class="bi bi-building-fill" style="color: #FFD700;"></i>
            <span class="text-white" style="font-size: 0.9rem;">Oficina: <strong>{{ oficina_seleccionada.nombre }}</strong></span>
            {% elif ruta_seleccionada %}
            <i class="bi bi-signpost-2-fill" style="color: #00FF99;"></i>
            <span class="text-white" style="font-size: 0.9rem;">Ruta: <strong>{{ ruta_seleccionada.nombre }}</strong>
                {% if ruta_seleccionada.cobrador %}
                <small class="text-muted">({{ ruta_seleccionada.cobrador.nombre }})</small>
                {% endif %}
            </span>
            {% endif %}
        </div>
        <a href="/ver-todas-rutas" class="btn btn-sm" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #E0E0E0; border-radius: 20px; padding: 4px 12px; font-size: 0.78rem;">
            <i class="bi bi-x-lg me-1"></i>Quitar
        </a>
    </div>
</div>
{% endif %}

<!-- ==================== BANNER BI DASHBOARD ==================== -->
<a href="/reportes" class="bi-banner mb-4">
    <div class="bi-banner-grid-bg"></div>
    <div class="d-flex align-items-center justify-content-between position-relative" style="z-index: 2;">
        <div class="d-flex align-items-center gap-3">
            <div class="bi-banner-icon-wrap">
                <i class="bi bi-bar-chart-line-fill"></i>
            </div>
            <div>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <h5 class="mb-0 text-white fw-bold" style="font-size: 1rem; letter-spacing: 0.3px;">Dashboard Inteligencia de Negocios</h5>
                    <span class="bi-banner-live-tag">
                        <span class="bi-banner-live-dot"></span>
                        EN VIVO
                    </span>
                </div>
                <p class="bi-sub mb-0 mt-1" style="color: rgba(255,255,255,0.4); font-size: 0.78rem;">
                    KPIs en tiempo real &bull; Cartera multi-moneda &bull; Metas &bull; Morosos &bull; Exportar PDF
                </p>
            </div>
        </div>
        <div class="bi-banner-go d-none d-md-flex align-items-center gap-2">
            <span style="font-size: 0.75rem; color: rgba(255,255,255,0.3); font-weight: 500;">Abrir</span>
            <i class="bi bi-arrow-right-short" style="font-size: 1.6rem;"></i>
        </div>
    </div>
</a>

<!-- ==================== ZONA 1: BARRA DE COMANDO ==================== -->
<div class="command-toolbar mb-4">
    <a href="{{ url_for('reportes.reporte_ruta') }}" class="cmd-btn cmd-primary">
        <i class="bi bi-person-badge"></i>
        <span>Reporte por Recaudador</span>
    </a>
    <a href="{{ url_for('finanzas.caja_gastos') }}" class="cmd-btn cmd-warning">
        <i class="bi bi-receipt-cutoff"></i>
        <span>Registrar Gasto</span>
    </a>
    <a href="{{ url_for('finanzas.caja_inicio') }}" class="cmd-btn cmd-outline">
        <i class="bi bi-safe"></i>
        <span>Caja General</span>
    </a>
</div>

<!-- ==================== ZONA 2: KPIs DE SUPERVISION ==================== -->
<div class="row g-3 mb-4">
    <!-- KPI 1: Balance del Día -->
    <div class="col-6 col-lg-3">
        <div class="kpi-card kpi-accent-green">
            <div class="kpi-header">
                <span class="kpi-label">Balance del Dia</span>
                <i class="bi bi-wallet2 kpi-icon" style="color: #00D67F;"></i>
            </div>
            {% for m in monedas_activas %}
            <div class="cv {% if not loop.first %}d-none{% endif %}" data-currency="{{ m }}">
                <div class="kpi-value {% if balance_dia_por_moneda.get(m, 0) >= 0 %}" style="color: #00D67F;"{% else %}" style="color: #FF4757;"{% endif %}>
                    {{ simbolos_moneda.get(m, '$') }} {{ "{:,.0f}".format(balance_dia_por_moneda.get(m, 0)) }}
                </div>
                <div class="d-flex justify-content-between">
                    <span class="kpi-detail positive">
                        <i class="bi bi-arrow-up-short"></i>{{ simbolos_moneda.get(m, '$') }} {{ "{:,.0f}".format(cobrado_hoy_por_moneda.get(m, 0)) }}
                    </span>
                    <span class="kpi-detail negative">
                        <i class="bi bi-arrow-down-short"></i>{{ simbolos_moneda.get(m, '$') }} {{ "{:,.0f}".format(gastos_hoy_por_moneda.get(m, 0)) }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- KPI 2: Eficacia de Cobro -->
    <div class="col-6 col-lg-3">
        <div class="kpi-card kpi-accent-blue">
            <div class="kpi-header">
                <span class="kpi-label">Eficacia de Cobro</span>
                <i class="bi bi-speedometer2 kpi-icon" style="color: #2563EB;"></i>
            </div>
            {% for m in monedas_activas %}
            <div class="cv {% if not loop.first %}d-none{% endif %}" data-currency="{{ m }}">
                <div class="kpi-value">{{ "{:.1f}".format(tasa_cobro_por_moneda.get(m, 0)) }}%</div>
                <div class="kpi-detail neutral">
                    {{ simbolos_moneda.get(m, '$') }} {{ "{:,.0f}".format(cobrado_hoy_por_moneda.get(m, 0)) }} de {{ simbolos_moneda.get(m, '$') }} {{ "{:,.0f}".format(flujo_cobro_por_moneda.get(m, 0)) }}
                </div>
                <div class="kpi-progress">
                    <div class="kpi-progress-bar" style="width: {{ [tasa_cobro_por_moneda.get(m, 0), 100]|min }}%;"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- KPI 3: Capital en Riesgo -->
    <div class="col-6 col-lg-3">
        <div class="kpi-card kpi-accent-red">
            <div class="kpi-header">
                <span class="kpi-label">Capital en Riesgo</span>
                <i class="bi bi-exclamation-triangle kpi-icon" style="color: #FF4757;"></i>
            </div>
            {% for m in monedas_activas %}
            <div class="cv {% if not loop.first %}d-none{% endif %}" data-currency="{{ m }}">
                <div class="kpi-value" style="{% if mora_por_moneda.get(m, 0) > 0 %}color: #FF4757;{% endif %}">
                    {{ mora_por_moneda.get(m, 0) }}
                </div>
                <div class="kpi-detail {% if mora_por_moneda.get(m, 0) > 0 %}negative{% else %}positive{% endif %}">
                    {% if mora_por_moneda.get(m, 0) > 0 %}
                    <i class="bi bi-exclamation-circle"></i>{{ simbolos_moneda.get(m, '$') }} {{ "{:,.0f}".format(monto_mora_por_moneda.get(m, 0)) }} en mora
                    {% else %}
                    <i class="bi bi-check-circle"></i>Sin mora activa
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- KPI 4: Utilidad Estimada -->
    <div class="col-6 col-lg-3">
        <div class="kpi-card kpi-accent-yellow">
            <div class="kpi-header">
                <span class="kpi-label">Utilidad Estimada</span>
                <i class="bi bi-graph-up-arrow kpi-icon" style="color: #F59E0B;"></i>
            </div>
            {% for m in monedas_activas %}
            <div class="cv {% if not loop.first %}d-none{% endif %}" data-currency="{{ m }}">
                <div class="kpi-value" style="color: #F59E0B;">
                    {{ simbolos_moneda.get(m, '$') }} {{ "{:,.0f}".format(ganancia_esperada_por_moneda.get(m, 0)) }}
                </div>
                <div class="kpi-detail positive">
                    <i class="bi bi-trending-up"></i>+{{ "{:.1f}".format(porcentaje_ganancia_por_moneda.get(m, 0)) }}% ROI
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- ==================== ZONA 3: ANALISIS RAPIDO ==================== -->
<div class="row g-3">
    <!-- Gráfico de Cobros 7 Días (60%) -->
    <div class="col-lg-7">
        <div class="panel-card">
            <div class="panel-title">
                <i class="bi bi-graph-up"></i>
                <span>Cobros - Ultimos 7 Dias</span>
                {% for m in monedas_activas %}
                <span class="cv badge ms-auto {% if not loop.first %}d-none{% endif %}" data-currency="{{ m }}"
                      style="background: rgba(0, 229, 255, 0.15); color: #00E5FF; font-size: 0.7rem;">
                    {{ simbolos_moneda.get(m, '$') }} {{ m }}
                </span>
                {% endfor %}
            </div>
            <div class="chart-wrapper">
                <canvas id="cobrosChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Feed de Últimos Gastos (40%) -->
    <div class="col-lg-5">
        <div class="panel-card" style="height: 100%; display: flex; flex-direction: column;">
            <div class="panel-title">
                <i class="bi bi-receipt-cutoff"></i>
                <span>Ultimos Gastos</span>
            </div>
            <div class="expense-feed" style="flex: 1;">
                {% if ultimos_gastos %}
                    {% for gasto in ultimos_gastos %}
                    <div class="expense-item" data-currency="{{ gasto.moneda or 'COP' }}">
                        <div class="expense-icon">
                            {% if gasto.concepto == 'Gasolina' %}
                                <i class="bi bi-fuel-pump"></i>
                            {% elif gasto.concepto == 'Alimentación' %}
                                <i class="bi bi-cup-hot"></i>
                            {% elif gasto.concepto == 'Transporte' %}
                                <i class="bi bi-bus-front"></i>
                            {% elif gasto.concepto == 'Mantenimiento' %}
                                <i class="bi bi-wrench"></i>
                            {% elif gasto.concepto == 'Comunicaciones' %}
                                <i class="bi bi-phone"></i>
                            {% else %}
                                <i class="bi bi-receipt"></i>
                            {% endif %}
                        </div>
                        <div class="expense-info">
                            <div class="expense-concept">{{ gasto.concepto }}{% if gasto.descripcion %} - {{ gasto.descripcion }}{% endif %}</div>
                            <div class="expense-meta">
                                {{ gasto.usuario_origen.nombre if gasto.usuario_origen else 'Sistema' }}
                                &middot; {{ gasto.fecha.strftime('%d/%m %H:%M') }}
                            </div>
                        </div>
                        <div class="expense-amount">
                            -{{ simbolos_moneda.get(gasto.moneda or 'COP', '$') }} {{ "{:,.0f}".format(gasto.monto) }}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="feed-empty">
                        <i class="bi bi-inbox"></i>
                        <span>Sin gastos registrados</span>
                    </div>
                {% endif %}
            </div>
            <a href="{{ url_for('finanzas.caja_gastos') }}" class="feed-link">
                Ver todos los gastos <i class="bi bi-arrow-right"></i>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ==================== SEARCHABLE RUTA SELECTOR ====================
    function filterRutas() {
        var input = document.getElementById('rutaSearchInput');
        var filter = input.value.toLowerCase();
        var items = document.querySelectorAll('.ruta-item');
        items.forEach(function(item) {
            var nombre = item.querySelector('.ruta-nombre').textContent.toLowerCase();
            item.style.display = nombre.includes(filter) ? '' : 'none';
        });
    }

    // ==================== CURRENCY CONTEXT SYSTEM ====================
    const monedas = {{ monedas_activas | tojson }};
    const simbolos = {{ simbolos_moneda | tojson }};
    let activeCurrency = monedas[0] || 'COP';

    // Chart data per currency
    const chartDataByCurrency = {{ cobros_7_dias_por_moneda | tojson }};
    const chartLabels = {{ labels_7_dias | tojson }};

    // Initialize Chart
    const cobrosCtx = document.getElementById('cobrosChart');
    let cobrosChart = null;
    if (cobrosCtx) {
        cobrosChart = new Chart(cobrosCtx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Cobros',
                    data: chartDataByCurrency[activeCurrency] || [],
                    backgroundColor: 'rgba(0, 229, 255, 0.08)',
                    borderColor: '#00E5FF',
                    borderWidth: 2.5,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#00E5FF',
                    pointBorderColor: '#161B22',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1D1E33',
                        titleColor: '#8B949E',
                        bodyColor: '#fff',
                        borderColor: 'rgba(0, 229, 255, 0.3)',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(ctx) {
                                const sym = simbolos[activeCurrency] || '$';
                                return sym + ' ' + ctx.parsed.y.toLocaleString('es-CO');
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#8D8E98',
                            font: { size: 11 },
                            callback: function(v) {
                                const sym = simbolos[activeCurrency] || '$';
                                if (v >= 1000000) return sym + (v/1000000).toFixed(1) + 'M';
                                if (v >= 1000) return sym + (v/1000).toFixed(0) + 'K';
                                return sym + v;
                            }
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.04)' }
                    },
                    x: {
                        ticks: { color: '#8D8E98', font: { size: 11 } },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // ==================== SWITCH CURRENCY ====================
    function switchCurrency(currency) {
        activeCurrency = currency;

        // Update toggle buttons
        document.querySelectorAll('.ct-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.currency === currency);
        });

        // Show/hide all currency-dependent values
        document.querySelectorAll('.cv').forEach(el => {
            if (el.dataset.currency === currency) {
                el.classList.remove('d-none');
                el.style.display = '';
            } else {
                el.classList.add('d-none');
            }
        });

        // Update chart data
        if (cobrosChart) {
            cobrosChart.data.datasets[0].data = chartDataByCurrency[currency] || [];
            cobrosChart.update('none');
        }

        // Filter expense feed
        document.querySelectorAll('.expense-item').forEach(el => {
            const itemCurrency = el.dataset.currency;
            el.style.display = (!itemCurrency || itemCurrency === currency) ? '' : 'none';
        });
    }
</script>
{% endblock %}
